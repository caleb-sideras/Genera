{% extends 'base.html' %}
{% load static %}

{% block head_block %}
<!-- <script type="text/javascript" src="{% static 'js/minting_page_vue.js' %}"></script> -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
<script src="https://unpkg.com/vue@next"></script>
{% endblock %}

{% block body_block %}


<div id="add-files-component" class="mint_upload_main">
  
  <add-files></add-files>
  <file-preview
    v-for="(value, name, index) in files"
    :name="name"
    :blob="value.blob"
    :fullrender="value.fullrender"
  ></file-preview>
  <template v-if:="Object.entries(active_element) != 0">
    <carousel :activeelement="active_element" :activekey="Object.keys(active_element)[0]" @next-carousel="nextDictEntry" @prev-carousel="prevDictEntry"></carousel>
  </template>
  <properties></properties>
  
</div>

<script>
  const app = Vue.createApp({
    data() {
      return {
        files: {},
        active_element: {}
      }
    },
    methods:{
      //refactor? fuck no
      nextDictEntry(){
        let file_keys = Object.keys(this.files);
        let currentKey = Object.keys(this.active_element)[0]
        let nextIndex =  file_keys.indexOf(currentKey) + 1

        if (nextIndex in file_keys) {
          var nextItem = file_keys[nextIndex];
        } else{
          var nextItem = file_keys[0]
        }
        try {
          let new_active = this.files[nextItem]
          this.active_element = {}
          this.active_element[nextItem] = new_active
        } catch (error) {
          console.log(error)
        }
        
      },
      prevDictEntry(){
        let file_keys = Object.keys(this.files);
        let currentKey = Object.keys(this.active_element)[0]
        let nextIndex =  file_keys.indexOf(currentKey) - 1

        if (nextIndex in file_keys) {
          var nextItem = file_keys[nextIndex];
        } else{
          var nextItem = file_keys[file_keys.length - 1]
        }

        try {
          let new_active = this.files[nextItem]
          this.active_element = {}
          this.active_element[nextItem] = new_active
        } catch (error) {
          console.log(error)
        }
        
      }
    }
  })
  //removing attribute line without save doesnt reload, need to :model data
  app.component('add-files', {
    template:
    `<input type="file" multiple accept="image/png, image/jpeg, .json" @change="onFileChange" ref="input" />`,
    methods: {
      // If metadata, file name
      onFileChange(event) {
        for (const file of event.target.files) {
          let self = this
          let parent = this.$root
          let fileName = file.name.replace(/\.[^/.]+$/, "")

          if (!parent.$data.files[fileName]) {
            parent.$data.files[fileName] = {}
          }

          if (!parent.$data.files[fileName]["blob"]) {
            const canvas = document.createElement("canvas")
            canvas.width = 250
            canvas.height = 250
            parent.$data.files[fileName]["blob"] = canvas.toDataURL()
          }

          if (file.type === "application/json") {
            function readFile(event) {
              parent.$data.files[fileName]["metadata"] = event.target.result
            }

            let reader = new FileReader()
            reader.addEventListener('load', readFile);
            reader.readAsText(file);
          }
          else if(file.type ==="image/jpeg" || file.type ==="image/png"){
            if (!parent.$data.files[fileName]["file"]){
              parent.$data.files[fileName]["file"] = file
              parent.$data.files[fileName]["fullrender"] =  URL.createObjectURL(file)
            }
          }    
        }
        // console.log(this.$root.$data.files)
      }
    }
  })

  app.component('file-preview', {
    delimiters: ["[[", "]]"],
    props: ['name', 'blob', 'fullrender'],
    template: `
      <div class="upload_card grow border rounded_container_no_padding" @click="activeElement" >
        <img loading="lazy" :src="[[ blob ]]" :alt ="[[ fullrender ]]" class="nft_image">
        <div class="loading_circle" style="display: none;"></div>
        <div>
          <p>[[ name ]]</p>  
        </div>
      </div>
    `,
    mounted() {
      const { $el } = this
      // console.log($el)
      // console.log(this)
      if (typeof(this.fullrender) !== 'undefined') {
        const observer = new IntersectionObserver(([entry]) => {
        const img = $el.querySelector(".nft_image")
        const loading = $el.querySelector(".loading_circle")

        if (entry.isIntersecting) {
          // Element is in viewport
          loading.style.display = "flex"
          let loadingImage = new Image();
          loadingImage.src = this.fullrender

          loadingImage.onload = () =>{
            delete loadingImage.onload
            loading.style.opacity = "0"
            img.src = loadingImage.src
            img.style.opacity = "1"
            setTimeout(() => {
              loading.style.display = "none"
            },100)
          }
          observer.disconnect()
        }
      })
      observer.observe($el)

      //find a way to destroy observer

      // this.$once("hook:beforeDestroy", () => {
      //   observer.disconnect()
      // })
      }
  },
    methods :{
      activeElement(event){
        let parent = this.$root
        parent.$data.active_element[this.name] = parent.$data.files[this.name]
      }
    }
  })
  //delete button
  app.component('carousel', {
    emits:['next-carousel', 'prev-carousel'],
    delimiters: ["[[", "]]"],
    props: ['activeelement', 'activekey'],
    template:` 

    <div class="image_preview"><div class="top_row"><img src="/static/icons/remove.svg"  @click="closeCarousel"></div><div class="rounded_container"><div class="content_wrapper">

      <div class="lbutton_wrapper" @click="prevCarousel">
        <img src="/static/icons/expand.svg" class="button left">
      </div>

    <div class="inner_content">

      <img :src="[[ activeelement[activekey].fullrender ]]" class="image">

    <div class="info"><div class="upper_info_wrapper">

      <template v-if:=" 'metadata' in activeelement[activekey]">
        <input required="" name="title" type="text" :value="[[ JSON.parse(activeelement[activekey].metadata).name ]]" placeholder="E.g. Internal Void" maxlength="50" minlength="1"  @change="validateField" style="margin: 20px; font-size: 25px;">
      </template>
      <template v-else>
        <input required="" name="title" type="text" :value="[[ activeelement[activekey].file.name ]]" placeholder="E.g. Internal Void" maxlength="50" minlength="1"  @change="validateField" style="margin: 20px; font-size: 25px;">
      </template>
      
      </div><div class="info_wrapper"><div class="general_button dropdown_button white_background" style="margin: 0px 10px 10px;"><h5 style="font-weight: bold; margin: 5px; font-size: 17px;">Description</h5><div class="expand_button_container" style="justify-content: center; width: 25px;"><img src="/static/icons/expand.svg" class="expand_collapse" style="width: auto;"></div>
      
      <div class="open" id="wrapper" style="padding: 15px 20px; margin-right: -20px; margin-left: -20px; width: 100%; text-align: start; display: flex; flex-direction: column;">

        <template v-if:=" 'metadata' in activeelement[activekey]">
          <template v-if:=" 'description' in JSON.parse(activeelement[activekey].metadata)">

            <textarea style="resize: vertical; box-sizing: border-box;" required="" class="inputize" name="description" type="" placeholder="E.g. A collection that shows the emptiness of the soul." :value ="[[ JSON.parse(activeelement[activekey].metadata).description ]]" maxlength="300" minlength="1" @change="validateField"></textarea>

          </template>
          <template v-else>
            <textarea style="resize: vertical; box-sizing: border-box;" required="" class="inputize" name="description" type="" placeholder="E.g. A collection that shows the emptiness of the soul." value="" maxlength="300" minlength="1"  @change="validateField"></textarea>
          </template>
        </template>
        <template v-else>
          <textarea style="resize: vertical; box-sizing: border-box;" required="" class="inputize" name="description" type="" placeholder="E.g. A collection that shows the emptiness of the soul." value="" maxlength="300" minlength="1"  @change="validateField"></textarea>
        </template>

      </div>
      </div>
      
      <div class="general_button dropdown_button white_background" style="margin: 0px 10px 10px;">
        <h5 style="font-weight: bold; margin: 5px; font-size: 17px;">Properties</h5>
        <div class="expand_button_container">
          <h5>2</h5>
          <img src="/static/icons/expand.svg" class="expand_collapse" style="transform: rotate(0deg);">
        </div>
      
      <div class="open" id="wrapper" style="padding: 15px 20px; margin-right: -20px; margin-left: -20px; width: 100%; text-align: start; display: flex; flex-direction: column;">

        <div style="display:flex; flex-direction:row; justify-content: space-around; margin-bottom: 10px;">
          <p class="no_margin">Trait Type</p>
          <p class="no_margin">Trait</p>
        </div>

        <template v-if:=" 'metadata' in activeelement[activekey]">
          <template v-if:=" 'attributes' in JSON.parse(activeelement[activekey].metadata)">

            <template v-for="value in JSON.parse(activeelement[activekey].metadata).attributes" :key="componentKey">
              <div style="display:flex; flex-direction:column; margin-bottom:10px;">
                <div style="display:flex; flex-direction:row; gap: 5px; align-items: center;">

                  <input required="" name="type" type="text" :value="[[ value['trait_type'] ]]" placeholder="E.g. Face" maxlength="50" minlength="1"  @change="validateField">

                  <input required="" name="trait" type="text" :value="[[ value['value'] ]]" placeholder="E.g. Angry Face" maxlength="50" minlength="1"  @change="validateField">

                  <img src="/static/icons/remove.svg" style="height: 15px; cursor: pointer; filter: var(--remove-button-color);" @click="removeAttribute">

                </div>

              </div>
            </template>
          </template>
        </template>
        <template v-for="index of inputs">
          <div style="display:flex; flex-direction:column; margin-bottom:10px;" id="new_row">
                
                <div style="display:flex; flex-direction:row; gap: 5px; align-items: center;">

                  <input required="" name="type" type="text" placeholder="E.g. Face" maxlength="50" minlength="1"  @change="validateField">

                  <input required="" name="trait" type="text" placeholder="E.g. Angry Face" maxlength="50" minlength="1"  @change="validateField">

                  <img src="/static/icons/remove.svg" style="height: 15px; cursor: pointer; filter: var(--remove-button-color);" @click="removeAttribute">

                </div>

              </div>
        </template>

        <img class="color_image_orange" src="/static/icons/plus.svg" id="add_layer_button" style="height: 55px; flex-grow: 1; cursor: pointer; align-self: end;" @click=newTrait>

      </div>
      
      </div>
      </div>

      <div class="mutipurpose_button_section">
        
        <div class="general_button_no_border mutipurpose_button">
          <h4 style="color: red;">Delete</h4>
        </div>

        <div class="general_button_no_border mutipurpose_button" @click=saveData>
          <h4 style="color: var(--main-color);">Save</h4>
        </div>

      </div>

      </div></div>

        <div class="rbutton_wrapper" @click="nextCarousel">
          <img src="/static/icons/expand.svg" class="button right">
        </div>

      </div></div></div>`,
    data() {
      return {
        inputs: [],
        componentKey : 0
      }
    },
    mounted(){
    },
    methods:{
      nextCarousel(event){
        this.$emit('next-carousel')
        this.removeInput(event)
      },
      prevCarousel(event){
        this.$emit('prev-carousel')
        this.removeInput(event)
      },
      newTrait(event){
        this.inputs.push(this.inputs.length+1)
      },
      removeInput(event){
        this.inputs = []
      },
      saveData(event){
        let info_section = document.querySelector(".info")
        let fields = info_section.querySelectorAll(":scope input, :scope textarea")
        for (var i = 0; i < fields.length; i++) {
          if (fields[i].checkValidity() && !fields[i].classList.contains("field_error")) {
              continue
          } else {
              fields[i].reportValidity()
              return
          }
        }

        let parent = this.$root
        if (metadata in parent.$data.files[this.activekey]) {
          var metadata = JSON.parse(parent.$data.files[this.activekey].metadata)
        }
        else{
          var metadata = {}
        }

        metadata['name'] = fields[0].value
        metadata['description'] = fields[1].value
        metadata['attributes'] = []
        for (var i = 2; i < fields.length; i+=2 ) {
          metadata['attributes'].push({"trait_type" : fields[i].value, "value" : fields[i+1].value})
        }
        parent.$data.files[this.activekey]['metadata'] = JSON.stringify(metadata)
        this.removeInput(event)
        // renders list, not best way but works
        this.componentKey += 1;  
      },
      validateField(event){
        if (event.target.checkValidity()) {
          event.target.classList.add("field_success")
          event.target.classList.remove("field_error")
        } else {
          event.target.classList.remove("field_success")
          event.target.classList.add("field_error")
        }
      },
      validateFields(){
        let info_section = document.querySelector(".info")

        if (info_section) {
          let fields = info_section.querySelectorAll(":scope input, :scope textarea")
          for (var i = 0; i < fields.length; i++) {
            fields[i].dispatchEvent(new Event('change'));
          }
        }  
      },
      closeCarousel(event){
        this.$root.$data.active_element = {}
      },
      removeAttribute(event){
        event.srcElement.parentElement.parentElement.remove()
      }
    },
    watch:{
      $props:{
        handler(){
          // such a scuffed way, waiting for dom to update from state
          // best way to do this is, new input fields fill up a structure then this triggers validations. don't have to use these values rn, but this way makes sure dom and state are matching
          setTimeout(() => {
            this.validateFields()
          },50)
        },
        deep: true,
        immediate: true,
      }
    }
  })
  //???
  app.component('properties', {
    template:
    `<div class="upload_properties">
      <div class="rounded_container shadow_strong">
        <h3 class="no_margin center" style="margin-bottom: 15px; font-size: 1.3rem;">Collection Properties</h3>
        <div class="upload_page_property_fields">
          <h5 class="no_margin">Collection Name</h5>
          <input
            required
            name="collection_name"
            type="text"
            placeholder="E.g. Void Chans"
            onchange = ajax_validate_field(this)
            maxlength="50"
          />
          <h5 class="no_margin">Image Name</h5>
          <input
            required
            name="image_name"
            type="text"
            placeholder="E.g. Void"
            maxlength="10"
          />
          <h5 class="no_margin">Token Name</h5>
          <input
            required
            name="token_name"
            type="text"
            placeholder="E.g. VDE"
            maxlength="9"
          />
          <h5 class="no_margin">Description</h5>
          <textarea
            style="resize: vertical"
            required
            class="inputize"
            name="description"
            type=""
            placeholder="E.g. A collection that shows the emptiness of the soul."
            maxlength="300"
          ></textarea>
          <h5 class="no_margin">Size</h5>
          <input
            required
            id="collection_size"
            min="0"
            max="1000"
            name="size"
            type="number"
            onchange = ajax_validate_field(this)
            placeholder="E.g. 150"
          />
          <h5 class="no_margin">Resolution</h5>
          <div style="display: flex; width: 100%; gap: 10px;">
            <input
              required
              name="resolution_x"
              type="number"
              min="100"
              max="4000"
              placeholder="X"
              title="X Resolution"
            />
              <input
              required
              name="resolution_y"
              type="number"
              min="100"
              max="4000"
              placeholder="Y"
              title="Y Resolution"
            />
          </div>
          <h5 class="no_margin">Texture Map Color</h5>
          <input
            style="width: 50%"
            required
            name="color"
            type="color"
            value="#FFFFFF"
          />
        </div>
      </div>
      <button disabled type="submit" style="display: none;"></button>
      <button
        id="preview"
        type="button"
        class="general_button_no_border sub_color_background shadow_strong rounded_container_no_padding"
        onclick="preview_button(this)"
      >
        <h4 class="no_margin">Preview</h4>
      </button>
      <p id="cooldown">30 second cooldown</p>
      <input type="hidden" name="rarity_map" id="rarity_map" value="">
      <input type="hidden" name="uploaded_data_dict" id="uploaded_data_dict" value="">
      <button
        type="button"
        id="upload_button_submit"
        class="general_button_no_border main_color_background shadow_strong rounded_container_no_padding"
      >
        <h4 class="no_margin generate">Generate</h4>
      </button>
      <!-- button not needed below -->
      <input type="submit" style="display:none;">

      <div style="display: none;" class="update_layer_parameters_menu rounded_container shadow_strong">
        <h3 class="no_margin center">Layer Properties</h3>
        <div style="height:auto; margin: 10px 0; display: flex; flex-direction: column; gap: 25px; align-items: center; justify-content: space-between;">
          <div style="text-align: center; width: 100%;">
            <h5 style="margin: 5px 0;">Layer Name</h5>
            <input class="general_input" id="layer_name_update_field" type="text">
          </div> 
          <button id="confirm_layer_properties_update" type="button" class="main_color_background general_input general_button_no_border"> <h3 class="no_margin generate">Update properties!</h3> </button>
        </div>


      </div>
    </div>`, 
    data() {
      return {
        inputs: [],
        componentKey : 0
      }
    },
    mounted(){
      console.log("YO")
    },
    methods: {
      whatever(){
        console.log("WTF")
      }
    }
  })

  app.mount('#add-files-component')
</script>

{% endblock %}